---
title: "Particle Tracking Methodology"
author: "Oak Ridges Moraine Groundwater Program"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(ggspatial)
library(sf)
library(rgdal)
library(rnaturalearth)
```

```{r basemap, include=FALSE}
lakes_sf <- ne_download(scale = 'large',
                        type = 'lakes',
                        category = 'physical') %>%
  sf::st_as_sf(lakes110, crs = 4269) %>%
  filter(name %in% c("Lake Ontario",
                     "Lake Erie",
                     "Lake Huron",
                     "Lake Simcoe",
                     "Lake Nipissing"))

lakes_sf$area <- as.numeric(st_area(lakes_sf))/1000000

# basemap (Great Lakes)
basemapGL <- ggplot() +
  theme_bw() +
  theme(axis.text = element_blank()) +  
  geom_sf(data = lakes_sf,
          mapping = aes(geometry = geometry),
          color = "black",
          fill = "lightblue")
```

```{r geospatial, include=FALSE}
model.bounds <- st_as_sf(readOGR("shp/230428-models.geojson",verbose = FALSE))
```


## Introduction

The [ORMGP particle tracking web-tool](https://www.oakridgeswater.ca/) returns both forward and backward sub-surface particle tracks from a user-selected location.  The tool is built upon [existing numerical groundwater models](/snapshots/md/numerical-model-custodianship-program.html) which in themselves have organized, synthesized and interpreted a wealth of hydrogeological information (e.g., boreholes, geological mapping, previous studies, etc.) to gain an understanding of the groundwater flow system. 

Here, the results from running these models to a steady state are collected. From these states, a virtual particle can be released in the model domain and its path can be traced.

Particle tracking can prove important and useful from a number of perspectives:

- For any groundwater study where degraded groundwater quality has been detected, particle tracking can provide an initial indication of where the degraded water quality might have originated.  An evaluation of backward tracking from the site can help to quickly point out up-gradient land uses that might be contributing to degraded water quality, while forward tracking can indicate potential areas at risk. More detailed follow up investigations can then be directed to the right area.

- For proposed development in rural areas, where water supplies are from wells, and where waste water is directed to septic systems, particle tracking is useful for showing the general direction of groundwater flow. The overall development can be designed to avoid having septic systems positioned such that they might affect nearby well water supplies. Even at a site scale, Knowing the generalized groundwater flow directions allows for appropriate siting of wells (up-gradient from septic systems) and septic beds (down-gradient of wells).  The particle tracking tool can also reveal potential up-gradient land uses that might have an influence on well water quality in a proposed development.

- Ecological studies, where aquatic organisms are of interest, could also make use of particle tracking.  By examining the backward particle tracking from streams, existing or proposed land uses that might affect stream water quality can be assessed, and potential mitigation proposed. Ecologically Groundwater Recharge Areas (EGRA, *formerly ESGRA*) make use of such particle tracks to link recharge to discharge areas.  If new important ecological stream reaches are identified, then preliminary delineation of EGRAs can be made using the tool.  This can lead to early mitigation activities.



# Numerical Model Selection

As of the date listed above, the following models have been made live:

1. Regional model (MODFLOW)
1. Halton Tier-3 (FEFLOW)
<!-- 1. South Halton (MODFLOW) -->
<!-- 1. CVC (FEFLOW) -->
<!-- 1. NVCA-SSEA (FEFLOW) -->
<!-- 1. Ramara Whites Talbot (MODFLOW) -->
<!-- 1. York Tier-3 (MODFLOW) -->
<!-- 1. Durham (MODFLOW) -->


```{r mapModels, echo=FALSE, message=FALSE, warning=FALSE}
basemapGL +
  annotation_map_tile(zoom=8) +
  geom_sf(data=model.bounds, fill='blue', alpha=.3) +
  geom_sf_label(data=model.bounds, aes(label = Name)) +
  coord_sf(default_crs = st_crs(4326),
           ylim = c(43.2, 44.9),
           xlim = c(-80.25, -77.5),
           expand = TRUE) +
  theme(axis.ticks = element_blank()) +
  labs(x=NULL,y=NULL)
```









# Methodology


A "Long-term average" flux field of the above models were computed by running each model to steady state. This is a standard numerical model *output*.

At every model prismatic cell (or element), a virtual particle was placed at its centroid (or top of water surface whichever less) and tracked forward and backward using the Pollock method for the MODFLOW models, and a vector triangulation scheme for the FEFLOW models. [Source code for the particle tracking can be found here](https://github.com/maseology/ptrack).


There are 2 fundamental model "types" that are present in our custodianship program: Finite Difference (FD) models (i.e., MODFLOW) and Finite Element (FE) models (i.e., FEFLOW, HydroGeoSphere). In source water protection, both types have proved more than sufficient to meet provincial guidance and planning demands.  However, when it comes to particle tracking, the type plays a large role in how model results are to be interpreted.


For Finite Difference (FD) models, the semi-analytical method of Pollock (1989) is applied. The spatial extent of an FD model can be thought of as a stacking of rectilinear blocks, leaving no gaps in its interior.



Finite Elements (FE) used in groundwater modelling in southern Ontario are entirely built using a triangulated irregular network covering the land surface. From this FE mesh, hydrostratigraphic layers are built, resulting in a stacking of triangular prisms. Here a 3D flux vector computed at the element centroid is extracted from the model and is assumed constant throughout the spatial extent of the prismatic element. This is here termed the "vector-based" method.


Please note that there are many particle tracking methodologies and algorithms, we have chosen what most convenient.

Numerical model cell/element size/orientation will have effects on the particle pathline calculation.



# "Centoidal" Particles

For the sake brevity, the term "model cell" can be interpreted as either an FD grid cell or an FE prism. The centroid is the center of mass of the cell.

Particles are tracked both backwards and forwards from the centroid of every grid cell in the model.  In all, this results in *a collection of particle pathlines that pass through the centroid of at least one model cell*.


Particles are attributed with:



## Data Compression

To improve user performance, particle pathlines from larger models (>1M cells) have to be simplified to reduce data size (i.e., data compression). As a rule of thumb, the particle tracking web tool performs best when the pathline file remains less than 2GB memory. 

These pathline files (outputted as a _"gob file"_ or [Go Binary](https://pkg.go.dev/encoding/binary): _\*.gob_) consist of a set of vertices each with knowledge of their neighbour vertices (either up and down gradient of the current location). It is these relationships that define the pathlines yet enable the user to take any point along a centroidal pathline and track from there.

There are three ways these data can be compressed either by:

1. removing excess detail, such as vertices in close proximity, an using polyline smoothing schemes.
    - here the so-called Ramer-Douglas-Peucker algorithm algorithm was applied with a 10m threshold
  
1. removing pathlines originating from cells in "pinched-out" layers

1. systematically removing whole pathlines
    - random pull: simply removing every n$^{th}$ pathline at random
    - area threshold (full exclusion, or random pull)
    - quality thresholds (FE meshes only, aspect ratios, Delaunay criterion, etc.)







# References

Pollock, D.W., 1989, Documentation of a computer program to compute and display pathlines using results from the U.S. Geological Survey modular three-dimensional finite-difference ground-water flow model: U.S. Geological Survey Open-File Report 89â€“381.