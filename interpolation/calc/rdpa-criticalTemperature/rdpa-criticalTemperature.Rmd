---
title: Critical Temperature Optimization
author: M. Marchildon
date: Last compiled `r format(Sys.time(),'%B %e, %Y')`
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(scales)
```


# Critical Temperature $(T_c)$

Precipitation data can come in the form of just that: "precipitation", without information of whether it's in the snow (solid) or rain (liquid) form. A simple solution would be to determine a "critical" temperature $(T_c)$ from which precipitation falls either as snow or rain:

$$
\text{Rainfall}=
\begin{cases}
\text{Precipitation}, & T_a>T_c\\
0 & \text{otherwise},
\end{cases}
$$

$$
\text{Snowfall}=
\begin{cases}
\text{Precipitation}, & T_a\leq T_c\\
0 & \text{otherwise}.
\end{cases}
$$


where $T_a$ is air temperature measured at land surface and is assumed to have some linear positive correlation with the temperature of the planetary boundary layer (Oke, 1987). Below, it is discussed how an optimal $T_c$ is determined for each of the 2,183 ~10km² [sub-watersheds delineated](/interpolants/modelling/waterbudgetmodel.html#sub-basins) across the [ORMGP](https://www.oakridgeswater.ca/) jurisdiction.

# Data Collected
## 6-hourly Precipitation
- Composite [CaPA-RPDA](https://weather.gc.ca/grib/grib2_RDPA_ps10km_e.html) 6-hourly precipitation $(P)$ accumulation distributed at 10-15km grids are interpolated to the ORMGP sub-watersheds, just short of a 2-decade period of record. 
- Following [ORMGP-FEWS](https://owrc.github.io/interpolants/interpolation/fews.html) workflow: `exportBasinCapaRdpa.xml`, exported `202009301300-CaPA-RDPA.nc`:

```   
float precipitation_amount(time=27392, stations=2813);
  :long_name = "precipitation_amount";
  :units = "mm";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

Period of record: 
  start date: 2001-12-31 19:00:00 -0500 EST
  end date: 2020-09-30 14:00:00 -0400 EDT
  (6-hourly)
```
*(netCDF metadata)*

## 6-hourly Temperature 
- Sub-daily, basin-interpolated air temperatures $(T_a)$ from [hourly scalar MSC stations are interpolated to the ORMGP sub-watersheds](https://owrc.github.io/interpolants/interpolation/hourly.html).
- Following [ORMGP-FEWS](https://owrc.github.io/interpolants/interpolation/fews.html) workflow: `preprocessMSCtoBasinsHourly.xml`, exported `202209271600-6hourlyBasin.nc`:

```
float air_temperature(time=48222, stations=2813);
  :long_name = "air_temperature";
  :units = "degree_Celsius";
  :_FillValue = -999.0f; // float
  :coordinates = "lat lon";

float air_pressure(time=48222, stations=2813);
  :long_name = "air_pressure";
  :units = "Pa";
  :_FillValue = -999.0f; // float
  :coordinates = "lat lon";

float relative_humidity(time=48222, stations=2813);
  :long_name = "relative_humidity";
  :units = "-";
  :_FillValue = -999.0f; // float
  :coordinates = "lat lon";

float wind_speed(time=48222, stations=2813);
  :long_name = "wind_speed";
  :units = "m/s";
  :_FillValue = -999.0f; // float
  :coordinates = "lat lon";

float water_potential_evaporation_amount(time=48222, stations=2813);
  :long_name = "water_potential_evaporation_amount";
  :units = "mm";
  :_FillValue = -999.0f; // float
  :coordinates = "lat lon";

Period of record: 
  start date: 21989-09-25T18:00:00+0000
  end date: 2022-09-28T00:00:00+0000
  (6-hourly)
```
*(netCDF metadata)*

## Daily Snowmelt
- Daily, basin-interpolated snowmelt $(P_M)$ from [SNODAS](interpolants/interpolation/daily.html).
- Following [ORMGP-FEWS](interpolants/interpolation/fews.html) workflow: `preprocessYCDBtoBasinsDaily.xml`, exported `202209271600-dailyBasin.nc`:

```
float max_air_temperature(time=44198, stations=2813);
  :long_name = "max_air_temperature";
  :units = "degree_Celsius";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

float min_air_temperature(time=44198, stations=2813);
  :long_name = "min_air_temperature";
  :units = "degree_Celsius";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

float rainfall_amount(time=44198, stations=2813);
  :long_name = "rainfall_amount";
  :units = "mm";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

float snowfall_amount(time=44198, stations=2813);
  :long_name = "snowfall_amount";
  :units = "mm";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

float surface_snow_melt_amount(time=44198, stations=2813);
  :long_name = "surface_snow_melt_amount";
  :units = "mm/d";
  :_FillValue = -9999.0f; // float
  :coordinates = "lat lon";

Period of record: 
  start date: 21901-09-26 05:00:00 UTC
  end date: 2022-09-28 05:00:00 UTC
  (daily)
``` 
*(netCDF metadata)*


# Results
```{r resultsLoad}
df <- read.csv("interpolation/calc/rdpa-criticalTemperature/dat/tcrit-summary.csv")
df.noSNODAS <- read.csv("interpolation/calc/rdpa-criticalTemperature/dat/tcrit-summary-noSNODAS.csv")
```

For this exercise, we need a complete and concurrent $P$ and $T_a$ time series, since the data have been interpolated to our sub-watershed, we have 2,813 of such time series. The limiting time step is 6-hours to match that of the CaPA-RDPA product. We also need a constraint, and seasonal snowmelt $(P_M)$ estimated using SNODAS aggregated to the same sub-watershed network is taken as the benchmark. Assuming the mass of $P_M$ originates as a proportion of total $P$ and that $T_a$ is a good predictor of its origin (i.e., snowmelt occurs in cold conditions) then we should be able to *"parse-out"* $P$ that has generally fallen as rain or snow.

Therefore At every sub-watershed, independently for each of the 19 seasons, $T_c$ is determined by computing:

$$
  P_S=
  \begin{cases}
  P, & T_a\leq T_c\\
  0 & \text{otherwise}
  \end{cases}
$$

For every "water year" season (Oct.-Sept.), $T_c$ is optimized such that:

$$
  \sum P_S \to \sum P_M
$$
That is snowfall predicted using $T_c$ is equal to the snowmelt predicted by SNODAS, year by year. This results in `r format(nrow(df),big.mark=",",scientific=FALSE)` separate $T_c$ optimizations averaging `r round(mean(df$tc), 1)`°C, with a mean residual/error $\left(\left|\sum P_S - \sum P_M \right|\right)$ of `r round(mean(df$diff),1)` mm, roughly `r round(mean(df$diff)/10,1)`\% of annual average precipitation. Below are the distributions of these results.


```{r plot1}
p0 <- df %>% ggplot() + 
  geom_histogram(aes(tc)) + 
  ylim(c(NA,12000)) + 
  labs(x="Tc (°C)")

p1 <- df %>% ggplot() + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank()) +
  geom_histogram(aes(diff)) + 
  ylim(c(NA,12000)) + 
  xlim(c(NA,25)) + 
  labs(x="residual (mm)")

grid.arrange(top="Distribuiotn of Tc and residuals",p0, p1, ncol=2)
```

Seasonally, there does appear to be a ~6-year oscillation around the mean, even after 2011, when the SNODAS data are used:

```{r plot2}
df %>% ggplot(aes(wy,tc)) + 
  theme(legend.title = element_blank(), legend.position = c(.9,.9)) +
  geom_boxplot(aes(group=wy)) + 
  geom_hline(aes(colour="blue", yintercept = mean(df$tc)), size=1.25, linetype='dashed', alpha=.7) +
  stat_smooth(aes(colour = "red")) + 
  geom_segment(aes(x = 2011, y = -5, xend = 2020.75, yend = -5), arrow = arrow(length = unit(0.25, "cm"), ends='both')) +
  annotate('text', x = 2013, y = -4, label = "SNODAS") +
  labs(title="Annual distribution of Tc", x="water year", y="Tc (°C)") +
  scale_colour_manual(values=c("blue","red"), labels=c("mean","GAM fitted"))
```


In the end, in 12 of 19 seasons did the grand mean sit within the inter-quartiles of the set of optimized critical temperatures.

Operationally, when needing to apply $T_c$ to real-time $P$ estimates, the mean critical temperature of `r round(mean(df$tc), 1)`°C, whereas this analysis will only apply to past seasons, once complete.



## Discussion

Overall, regional $T_c$ managed to remain close to the freezing point as expected. There are some rare outliers, hover all seem to converge to negligible residuals. Based on these results, the CaPA-RDPA precipitation field are parsed into the $P_R$ and $P_S$ components at the 6-hour time step, then aggregated to daily time steps.



```{r plot3}
df %>% ggplot(aes(wy,tc)) + 
  theme(legend.title = element_blank(), legend.position = c(.9,.9)) +
  geom_boxplot(aes(group=wy), outlier.shape = NA) + 
  stat_smooth(aes(colour = "red")) + 
  stat_smooth(data=df.noSNODAS,aes(wy,tc,colour = "blue")) + 
  geom_segment(aes(x = 2011, y = -5, xend = 2020.75, yend = -5), arrow = arrow(length = unit(0.25, "cm"), ends='both')) +
  annotate('text', x = 2013, y = -4, label = "SNODAS") +
  labs(title="Annual distribution of Tc", x="water year", y="Tc (°C)") +
  scale_colour_manual(values=c("blue","red"), labels=c("no SNODAS","GAM fitted"))
```

```{r plot4}
df %>% ggplot(aes(wy,diff/psum*100)) + 
  theme(legend.title = element_blank(), legend.position = c(.9,.9)) +
  geom_boxplot(aes(group=wy), outlier.shape = NA) + 
  stat_smooth(aes(colour = "red")) + 
  stat_smooth(data=df.noSNODAS,aes(wy,diff/psum*100,colour = "blue")) + 
  geom_segment(aes(x = 2011, y = -0.1, xend = 2020.75, yend = -0.1), arrow = arrow(length = unit(0.25, "cm"), ends='both')) +
  annotate('text', x = 2013, y = -0.05, label = "SNODAS") +
  labs(title="Annual distribution of optimizaiton residuals", x="water year", y="residual (% annual precipitation)") +
  scale_colour_manual(values=c("blue","red"), labels=c("no SNODAS","GAM fitted")) +
  ylim(c(-0.1,1.25))
```

```{r plot5}
df %>% select(-c("tc","diff","msum")) %>%
  gather(src, precip, -sid, -wy) %>%
  ggplot(aes(wy,precip, fill=src)) +
  theme(legend.position = c(.82,.15)) +
  geom_bar(stat="identity", width=.85, position = "dodge") +
  # geom_segment(aes(x = 2011, y = 500, xend = 2020.75, yend = 500), size = 1, arrow = arrow(length = unit(0.25, "cm"), ends='both')) +
  # annotate(geom="label", x = 2013, y = 500, label = "SNODAS", fontface = "bold", fill = "white") +
  scale_fill_manual("source", values = c("psum" = "#0161e0", "psum2" = "#ff3975"),
                    labels = c("psum" = "CaPA-RDPA", "psum2" = "MSC (scalar)")) +
  scale_y_continuous(limits=c(500,NA),oob = rescale_none) +
  labs(title = "Comparison of regional precipitation", y="Precipitation (mm/yr)", x="water year")
```


blah

![Annual distribution of optimized Tc](E:/Sync/@dev/pages_owrc/interpolants/interpolation/calc/rdpa-criticalTemperature/gif/png.gif)


# Data files
The following data files used in the above analysis have been interpolated to the 2,813 sub-watersheds.

- [`202009301300-CaPA-RDPA.nc`](google.ca) daily
- `202209271600-6hourlyBasin.nc` hourly
- `202209271600-dailyBasin.nc` Capa


# References

Oke, T.R., 1987. Boundary Layer Climates, 2nd ed. London: Methuen, Inc.